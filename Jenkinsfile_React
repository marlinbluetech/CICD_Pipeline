@Library('Jenkins-SharedLibrary') _

pipeline {
    agent {label 'Built-In'}
  
    environment{
        appName = 'mbgheri'
        userEmail = 'ranjit.swain@marlinbluetech.com'
        userName = 'Ranjit Swain'
        branch = 'master'
        repoURL = 'https://github.com/marlinbluetech/mbgheri.git'

        //Deploy
        userid = 'root'
        environ = 'dev'
        server = 'test.marlinbluetech.com'
        deployPath = '/var/www/test.marlinbluetech.com/html/'

       // This can be nexus3 or nexus2
        NEXUS_VERSION = "nexus3"
        // This can be http or https
        NEXUS_PROTOCOL = "http"
        // Where your Nexus is running
        NEXUS_URL = "3.110.212.151:8081"
        // Repository where we will upload the artifact
        NEXUS_REPOSITORY = "mbgheri"
        // Jenkins credential id to authenticate to Nexus OSS
        NEXUS_CREDENTIAL_ID = "nexusCredential"
        ARTIFACT_VERSION = "${BUILD_NUMBER}"
    }

    stages{
        stage('Build React App'){
            agent {label 'reactDev'}
            steps{
                script{
                    build.react()
                }
            }
        }
        stage('Push To GitHub Repo'){
            agent {label 'reactDev'}
            steps{
                script{
                    gitCheckout.push2Remote()
                    //Delete local copy of the zip file
                    bat """
                        del "F:\\${appName}\\${appName}-${BUILD_NUMBER}.zip"
                    """
                }
            }
        }
        stage('Checkout'){
            steps{
                script{
                    gitCheckout.checkout()
                }
            }
        }
        stage('Upload To Nexus'){
            steps{
                script{
                    //nexusUpload()
                    sh """
                        curl -X 'POST' \
                        'http://nexus.marlinbluetech.com:8081/service/rest/v1/components?repository=mbgheri' \
                        -H 'accept: application/json' \
                        -H 'Content-Type: multipart/form-data' \
                        -H 'Authorization: Basic YWRtaW46YWRtaW4xMjMK' \
                        -F 'raw.directory=mbgheri' \
                        -F 'raw.asset1=@"${WORKSPACE}/${appName}-${BUILD_NUMBER}.zip";type=application/x-zip-compressed' \
                        -F 'raw.asset1.filename=${appName}-${BUILD_NUMBER}.zip'
                    """
                }
            }
        }
        stage('Deploy'){
          // Execute the Ansible playbook
            steps{
                script{
                    bat '''
                      echo "Execute Ansible"
                    '''
                }
            }
        }
    }
}
